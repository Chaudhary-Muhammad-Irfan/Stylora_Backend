@model List<WebApplication1.Models.Cart>

<main class="main">
    <!-- Breadcrumb -->
    <section class="breadcrumb">
        <ul class="breadcrumb__list flex container">
            <li><a href="@Url.Action("Index", "Home")" class="breadcrumb__link">Home</a></li>
            <li><span class="breadcrumb__link"></span>></li>
            <li><span class="breadcrumb__link">Shop</span></li>
            <li><span class="breadcrumb__link"></span>></li>
            <li><span class="breadcrumb__link">Cart</span></li>
        </ul>
    </section>

    <!-- Cart Section -->
    <section class="cart section--lg container">
        @if (Model == null || !Model.Any())
        {
            <div class="alert alert-info">Your cart is empty</div>
            <div class="cart__actions">
                <a href="@Url.Action("Index", "Shop")" class="btn flex btn__md">
                    <i class="fi-rs-shopping-bag"></i> Continue Shopping
                </a>
            </div>
        }
        else
        {
            <div class="table__container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Subtotal</th>
                            <th>Remove</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>
                                    <img src="@Url.Content($"~/{item.productThumbnailURL}")"
                                         alt="@item.productName"
                                         class="table__img" />
                                </td>
                                <td>
                                    <h3 class="table__title">@item.productName</h3>
                                    <p class="table__description">
                                        @item.brandName
                                    </p>
                                </td>
                                <td>
                                    <span class="table__price">Rs.@item.price.ToString("N0")</span>
                                </td>
                                <td>
                                    <input type="number"
                                           value="@item.quantity"
                                           min="1"
                                           max="100"
                                           class="quantity"
                                           data-cart-id="@item.cardId" />
                                </td>
                                <td><span class="subtotal">Rs.@item.subTotal.ToString("N0")</span></td>
                                <td>
                                    <form method="post" action="@Url.Action("RemoveFromCart", "Customer")">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="productId" value="@item.productId" />
                                        <button type="submit" class="btn btn-link">
                                            <i class="fi fi-rs-trash table__trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="cart__actions">
                <button id="updateCartBtn" class="btn flex btn__md">
                    <i class="fi-rs-shuffle"></i> Update Cart
                </button>
                <a href="@Url.Action("Index", "Shop")" class="btn flex btn__md">
                    <i class="fi-rs-shopping-bag"></i> Continue Shopping
                </a>
            </div>

            <div class="divider">
                <i class="fi fi-rs-fingerprint"></i>
            </div>

            <div class="cart__group grid">
                <div>
                    <div class="cart__shippinp">
                        <h3 class="section__title">Calculate Shipping</h3>
                        <form action="" class="form grid">
                            <input type="text"
                                   class="form__input"
                                   placeholder="State / Country" />
                            <div class="form__group grid">
                                <input type="text" class="form__input" placeholder="City" />
                                <input type="text"
                                       class="form__input"
                                       placeholder="PostCode" />
                            </div>
                            <div class="form__btn">
                                <button class="btn flex btn--sm">
                                    <i class="fi-rs-shuffle"></i> Update
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="cart__coupon">
                        <h3 class="section__title">Apply Coupon</h3>
                        <form action="" class="coupon__form form grid">
                            <div class="form__group grid">
                                <input type="text"
                                       class="form__input"
                                       placeholder="Enter Your Coupon" />
                                <div class="form__btn">
                                    <button class="btn flex btn--sm">
                                        <i class="fi-rs-label"></i> Apply
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="cart__total">
                    <h3 class="section__title">Cart Totals</h3>
                    <table class="cart__total-table">
                        <tr>
                            <td><span class="cart__total-title">Cart Subtotal</span></td>
                            <td><span class="cart__total-price">Rs.@Model.Sum(i => i.subTotal).ToString("N0")</span></td>
                        </tr>
                        <tr>
                            <td><span class="cart__total-title">Shipping</span></td>
                            <td><span class="cart__total-price">Rs.0.00</span></td>
                        </tr>
                        <tr>
                            <td><span class="cart__total-title">Total</span></td>
                            <td><span class="cart__total-price">Rs.@Model.Sum(i => i.subTotal).ToString("N0")</span></td>
                        </tr>
                    </table>
                    <a href="@Url.Action("Checkout", "Customer")" class="btn flex btn--md">
                        <i class="fi fi-rs-box-alt"></i> Proceed To Checkout
                    </a>
                </div>
            </div>
        }
    </section>
</main>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Update cart quantities
            document.getElementById('updateCartBtn').addEventListener('click', function() {
                const quantityInputs = document.querySelectorAll('.quantity');
                const updates = [];

                quantityInputs.forEach(input => {
                    updates.push({
                        cartId: input.dataset.cartId,
                        quantity: input.value
                    });
                });

                fetch('@Url.Action("UpdateCartQuantities", "Customer")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(updates)
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Error updating cart');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating cart');
                });
            });
        });
    </script>
}